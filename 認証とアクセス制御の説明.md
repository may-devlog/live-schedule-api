# 認証とアクセス制御の説明

## 現在の挙動

### ローカル環境と本番環境の違い

**ローカル環境:**
- 以前ログインしたことがある場合、`localStorage`（Web環境）にトークンが保存されています
- そのため、人のアイコン（👤）が表示され、ログイン済みとして扱われます
- スケジュールの作成・編集・複製が可能です

**本番環境:**
- ブラウザが異なるため、`localStorage`にトークンが保存されていません
- そのため、鍵のアイコン（🔐）が表示され、未ログインとして扱われます
- スケジュールの作成・編集・複製はできません（ログインが必要）

### 認証の仕組み

1. **フロントエンド（認証状態の管理）**
   - `AuthContext`が`localStorage`に保存されたトークンで認証状態を判定
   - トークンがある場合: `isAuthenticated = true`（ログイン済み）
   - トークンがない場合: `isAuthenticated = false`（未ログイン）

2. **バックエンド（認証の処理）**
   - `DISABLE_AUTH=true`が設定されている場合、認証が無効化されています
   - しかし、フロントエンドでは認証状態を管理しているため、ログインが必要です

### スケジュールの書き換え保護

以下の機能は、ログイン済みの場合のみ利用可能です：

1. **スケジュールの作成**
   - `new.tsx`: 未ログインの場合はログイン画面にリダイレクト
   - 「+ New Live」ボタンはログイン済みの場合のみ表示

2. **スケジュールの編集・複製**
   - `live/[id].tsx`: 編集・複製ボタンはログイン済みの場合のみ表示
   - 更新APIは`authenticatedFetch`を使用しており、トークンが必要

3. **交通情報・宿泊情報の編集**
   - 編集・削除機能は`authenticatedFetch`を使用しており、トークンが必要

## 自分しか利用しない場合の推奨設定

### オプション1: 本番環境でもログインする（推奨）

1. 本番環境で鍵のアイコン（🔐）をクリック
2. ログインモーダルでメールアドレスとパスワードを入力
3. ログイン後、人のアイコン（👤）が表示され、スケジュールの作成・編集が可能になります

**メリット:**
- セキュリティが確保される
- 他の人がアクセスしても、ログインしない限りスケジュールを書き換えられない

**デメリット:**
- 毎回ログインが必要（ブラウザを閉じるとトークンが消える場合がある）

### オプション2: ブラウザのlocalStorageにトークンを保存

1. 本番環境で一度ログインする
2. ブラウザの`localStorage`にトークンが保存される
3. 次回アクセス時もログイン済みとして扱われる

**注意:**
- ブラウザのキャッシュをクリアすると、トークンが消えます
- 別のブラウザやデバイスからアクセスする場合は、再度ログインが必要です

### オプション3: 認証を完全に無効化（非推奨）

現在、バックエンドでは`DISABLE_AUTH=true`が設定されており、認証が無効化されています。
しかし、フロントエンドでは認証状態を管理しているため、完全に無効化するには追加の実装が必要です。

**非推奨の理由:**
- セキュリティリスクが高まる
- 他の人がアクセスすると、スケジュールを書き換えられる可能性がある

## 現在の保護機能

以下の機能は、ログイン済みの場合のみ利用可能です：

1. ✅ スケジュールの作成（`/new`）
2. ✅ スケジュールの編集（`/live/[id]/edit`）
3. ✅ スケジュールの複製（`/live/[id]`の「複製」ボタン）
4. ✅ 交通情報の編集・削除
5. ✅ 宿泊情報の編集・削除

**閲覧のみ:**
- スケジュール一覧の表示（`/`）
- スケジュール詳細の表示（`/live/[id]`）
- 年別スケジュールの表示（`/year/[year]`）

これらはログイン不要で閲覧可能です。

## まとめ

- **ローカル環境**: 以前ログインしたことがあるため、ログイン済みとして表示される
- **本番環境**: ブラウザが異なるため、未ログインとして表示される
- **スケジュールの書き換え**: ログインが必要（保護されている）
- **推奨**: 本番環境でも一度ログインして、トークンを`localStorage`に保存する
















