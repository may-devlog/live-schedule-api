# AWS移行計画 - 概要

## 1. フロントエンド（Cloudflare）とバックエンド（AWS）の分離運用について

### ✅ 完全に可能です

**フロントエンド（Cloudflare Pages）とバックエンド（AWS）の分離運用は一般的な構成で、以下のメリットがあります：**

1. **最適なサービスを選択可能**
   - フロントエンド: Cloudflare Pages（CDN、高速配信、無料枠あり）
   - バックエンド: AWS（スケーラビリティ、セキュリティ、信頼性）

2. **CORS設定で接続**
   - フロントエンドからバックエンドAPIへのリクエストはCORSで制御
   - 既存の実装で対応済み（`ALLOWED_ORIGIN`環境変数）

3. **独立したスケーリング**
   - フロントエンドとバックエンドを個別にスケール可能
   - コスト最適化が容易

4. **セキュリティの向上**
   - バックエンドをVPC内に配置可能
   - セキュリティグループでアクセス制御

## 2. 現在の構成

### Fly.io構成
- **アプリケーション**: Rust (Axum) + SQLite
- **リソース**: 1 vCPU, 256MB RAM
- **ストレージ**: Fly.io Volume (SQLiteファイル)
- **リージョン**: 東京 (nrt) / シンガポール (sin)

### 移行先AWS構成（推奨）
- **コンテナ実行**: AWS ECS Fargate
- **データベース**: AWS RDS PostgreSQL
- **ロードバランサー**: Application Load Balancer (ALB)
- **ストレージ**: EFS（必要に応じて）
- **リージョン**: ap-northeast-1 (東京)

## 3. 移行のメリット

### セキュリティ
- ✅ VPC内でのネットワーク分離
- ✅ セキュリティグループによる細かいアクセス制御
- ✅ AWS Secrets Managerによる機密情報管理
- ✅ CloudWatchによる監視とアラート

### スケーラビリティ
- ✅ 自動スケーリング（ECS Auto Scaling）
- ✅ マルチAZ構成による高可用性
- ✅ データベースの自動バックアップ（RDS）

### 運用性
- ✅ AWSマネジメントコンソールでの一元管理
- ✅ CloudWatch Logsによるログ集約
- ✅ AWS Systems Managerによるパッチ管理

### コスト
- ✅ 使用量に応じた従量課金
- ✅ リザーブドインスタンスによる割引
- ✅ 無料枠の活用（新規アカウントの場合）

## 4. 移行の流れ

```
[現在] Fly.io (SQLite)
    ↓
[ステップ1] データベース移行準備
    ↓
[ステップ2] AWS環境構築
    ↓
[ステップ3] アプリケーション移行（PostgreSQL対応）
    ↓
[ステップ4] 並行運用期間（検証）
    ↓
[ステップ5] DNS切り替え
    ↓
[完了] AWS (PostgreSQL)
```

## 5. 必要な作業

### バックエンド側
1. SQLiteからPostgreSQLへの移行
2. データベース接続コードの変更
3. Dockerfileの調整
4. 環境変数の設定
5. ECSタスク定義の作成
6. ALB設定

### フロントエンド側
1. APIエンドポイントURLの変更（環境変数）
2. CORS設定の確認

### インフラ側
1. AWSアカウントの準備
2. VPC、サブネットの作成
3. RDSインスタンスの作成
4. ECSクラスターの作成
5. ALBの作成
6. Route53でのDNS設定

## 6. リスクと対策

| リスク | 対策 |
|--------|------|
| データ損失 | 移行前に完全バックアップ、並行運用期間を設ける |
| ダウンタイム | ブルー・グリーンデプロイメント、段階的切り替え |
| コスト超過 | 料金アラート設定、リソースタグ付け |
| パフォーマンス低下 | 負荷テスト実施、モニタリング強化 |

## 次のステップ

- [02-preparation.md](./02-preparation.md) - 移行前の準備とデータベース移行

