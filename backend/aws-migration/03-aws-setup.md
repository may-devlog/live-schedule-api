# AWS移行計画 - AWS環境構築手順

## 1. AWSアカウントの準備

### 1.1 AWSアカウントの作成
- [ ] AWSアカウントを作成（未作成の場合）
- [ ] MFA（多要素認証）を有効化
- [ ] 請求アラートを設定（予算超過を防ぐ）

### 1.2 IAMユーザーの作成
- [ ] 管理者用IAMユーザーを作成（ルートアカウントは使用しない）
- [ ] 適切な権限ポリシーを付与
- [ ] アクセスキーを生成・保存（安全な場所に）

### 1.3 リージョンの選択
- **推奨**: `ap-northeast-1` (東京)
- 理由: 低レイテンシー、データ主権、コスト

## 2. VPCとネットワークの構築

### 2.1 VPCの作成

**AWSマネジメントコンソールでの操作：**

1. **VPCダッシュボード**に移動
2. **VPCの作成**をクリック
3. 以下の設定を入力：
   - **名前タグ**: `live-schedule-vpc`
   - **IPv4 CIDR**: `10.0.0.0/16`
   - **テナンシー**: デフォルト

### 2.2 サブネットの作成

**パブリックサブネット（ALB用）:**
- **名前**: `live-schedule-public-1a`
- **AZ**: `ap-northeast-1a`
- **CIDR**: `10.0.1.0/24`

- **名前**: `live-schedule-public-1c`
- **AZ**: `ap-northeast-1c`
- **CIDR**: `10.0.2.0/24`

**プライベートサブネット（ECS/RDS用）:**
- **名前**: `live-schedule-private-1a`
- **AZ**: `ap-northeast-1a`
- **CIDR**: `10.0.10.0/24`

- **名前**: `live-schedule-private-1c`
- **AZ**: `ap-northeast-1c`
- **CIDR**: `10.0.11.0/24`

### 2.3 インターネットゲートウェイの作成

1. **インターネットゲートウェイ**を作成
2. VPCにアタッチ
3. ルートテーブルに追加（パブリックサブネット用）

### 2.4 NATゲートウェイの作成（プライベートサブネット用）

1. **NATゲートウェイ**を作成
2. パブリックサブネットに配置
3. プライベートサブネットのルートテーブルに追加

**注意**: NATゲートウェイは約$32/月のコストがかかります。

### 2.5 セキュリティグループの作成

**ALB用セキュリティグループ:**
- **名前**: `live-schedule-alb-sg`
- **インバウンドルール**:
  - HTTP (80): 0.0.0.0/0
  - HTTPS (443): 0.0.0.0/0
- **アウトバウンドルール**: すべて許可

**ECS用セキュリティグループ:**
- **名前**: `live-schedule-ecs-sg`
- **インバウンドルール**:
  - カスタムTCP (3000): ALBセキュリティグループからのみ
- **アウトバウンドルール**: すべて許可

**RDS用セキュリティグループ:**
- **名前**: `live-schedule-rds-sg`
- **インバウンドルール**:
  - PostgreSQL (5432): ECSセキュリティグループからのみ
- **アウトバウンドルール**: なし

## 3. RDS PostgreSQLの作成

### 3.1 RDSインスタンスの作成

**AWSマネジメントコンソールでの操作：**

1. **RDSダッシュボード**に移動
2. **データベースの作成**をクリック
3. 以下の設定を入力：

**エンジンの選択:**
- **エンジンのタイプ**: PostgreSQL
- **バージョン**: 15.x（最新の安定版）

**テンプレート:**
- **本番環境**: 本番環境（小規模）
- **開発/テスト**: 開発/テスト（コスト削減）

**設定:**
- **DBインスタンス識別子**: `live-schedule-db`
- **マスターユーザー名**: `postgres`（または任意）
- **マスターパスワード**: 強力なパスワードを生成・保存

**インスタンス構成:**
- **DBインスタンスクラス**: `db.t3.micro`（無料枠）または `db.t3.small`（本番推奨）
- **ストレージ**: 
  - **タイプ**: 汎用SSD (gp3)
  - **割り当て済みストレージ**: 20 GB（初期）

**接続:**
- **VPC**: `live-schedule-vpc`
- **サブネットグループ**: 新規作成（プライベートサブネットを選択）
- **パブリックアクセス**: いいえ
- **VPCセキュリティグループ**: `live-schedule-rds-sg`
- **可用性ゾーン**: デフォルト

**データベース認証:**
- **パスワード認証**: 選択

**追加設定:**
- **初期データベース名**: `live_schedule`
- **バックアップ保持期間**: 7日間
- **バックアップウィンドウ**: メンテナンスウィンドウと同期
- **自動マイナーバージョンアップグレード**: 有効化

### 3.2 エンドポイントの確認

RDS作成後、**エンドポイント**をメモ：
- 例: `live-schedule-db.xxxxxxxxx.ap-northeast-1.rds.amazonaws.com:5432`

## 4. ECSクラスターの作成

### 4.1 ECSクラスターの作成

**AWSマネジメントコンソールでの操作：**

1. **ECSダッシュボード**に移動
2. **クラスターの作成**をクリック
3. 以下の設定を入力：

**クラスター設定:**
- **クラスター名**: `live-schedule-cluster`
- **インフラストラクチャ**: AWS Fargate（サーバーレス）

### 4.2 ECRリポジトリの作成（Dockerイメージ用）

1. **ECRダッシュボード**に移動
2. **リポジトリの作成**をクリック
3. 以下の設定を入力：
- **可視性設定**: プライベート
- **リポジトリ名**: `live-schedule-api`
- **タグの不変性**: 無効（開発中は有効化推奨）

**プッシュコマンド**（後で使用）:
```bash
# ログイン
aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin <アカウントID>.dkr.ecr.ap-northeast-1.amazonaws.com

# タグ付け
docker tag live-schedule-api:latest <アカウントID>.dkr.ecr.ap-northeast-1.amazonaws.com/live-schedule-api:latest

# プッシュ
docker push <アカウントID>.dkr.ecr.ap-northeast-1.amazonaws.com/live-schedule-api:latest
```

## 5. Application Load Balancer (ALB)の作成

### 5.1 ALBの作成

**AWSマネジメントコンソールでの操作：**

1. **EC2ダッシュボード** → **ロードバランサー**に移動
2. **ロードバランサーの作成**をクリック
3. **Application Load Balancer**を選択
4. 以下の設定を入力：

**基本設定:**
- **名前**: `live-schedule-alb`
- **スキーム**: インターネット向け
- **IPアドレスのタイプ**: IPv4

**ネットワークマッピング:**
- **VPC**: `live-schedule-vpc`
- **マッピング**: 
  - `ap-northeast-1a`: パブリックサブネット1を選択
  - `ap-northeast-1c`: パブリックサブネット2を選択

**セキュリティ設定:**
- **セキュリティグループ**: `live-schedule-alb-sg`

**リスナーの設定:**
- **プロトコル**: HTTP
- **ポート**: 80
- **デフォルトアクション**: ターゲットグループに転送（後で作成）

### 5.2 ターゲットグループの作成

1. **ターゲットグループの作成**をクリック
2. 以下の設定を入力：

**基本設定:**
- **ターゲットタイプ**: IPアドレス
- **名前**: `live-schedule-tg`
- **プロトコル**: HTTP
- **ポート**: 3000
- **VPC**: `live-schedule-vpc`

**ヘルスチェック:**
- **ヘルスチェックパス**: `/health`（または`/`）
- **正常性チェック間隔**: 30秒
- **正常しきい値**: 2
- **異常しきい値**: 3
- **タイムアウト**: 5秒

## 6. Route53でのDNS設定（オプション）

### 6.1 ホストゾーンの作成

1. **Route53ダッシュボード**に移動
2. **ホストゾーンの作成**をクリック
3. **ドメイン名**を入力（例: `yourdomain.com`）

### 6.2 Aレコードの作成

1. **レコードの作成**をクリック
2. 以下の設定を入力：
- **レコード名**: `api`（`api.yourdomain.com`の場合）
- **レコードタイプ**: A - IPv4アドレスとルーティングトラフィック
- **エイリアス**: はい
- **エイリアス先**: Application Load Balancer
- **リージョン**: ap-northeast-1
- **ロードバランサー**: `live-schedule-alb`

## 7. AWS Secrets Managerの設定

### 7.1 シークレットの作成

1. **Secrets Managerダッシュボード**に移動
2. **新しいシークレットの保存**をクリック
3. 以下の設定を入力：

**シークレットタイプ:**
- **その他のシークレット**を選択

**シークレット値:**
```json
{
  "JWT_SECRET": "your-jwt-secret-here",
  "DATABASE_URL": "postgresql://user:password@host:5432/dbname",
  "RESEND_API_KEY": "your-resend-api-key"
}
```

**シークレット名:**
- `live-schedule-api-secrets`

**自動ローテーション:**
- 無効（必要に応じて有効化）

## 8. CloudWatch Logsの設定

### 8.1 ロググループの作成

1. **CloudWatchダッシュボード** → **ロググループ**に移動
2. **ロググループの作成**をクリック
3. **ロググループ名**: `/ecs/live-schedule-api`

## 次のステップ

- [04-application-migration.md](./04-application-migration.md) - アプリケーション移行とデプロイ

