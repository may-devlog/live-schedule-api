# リージョン切り替えガイド

シンガポールリージョンと東京リージョンの間で切り替える手順です。

## 📋 概要

- **シンガポール → 東京**: リソース不足が解消された場合の復帰
- **東京 → シンガポール**: リソース不足が発生した場合の避難

---

## 1. シンガポールリージョンへの避難（東京 → シンガポール）

### 自動スクリプト

```bash
cd backend
./scripts/switch-to-backup-region.sh
```

### 処理内容

1. ✅ 東京リージョンから最新のデータベースをバックアップ
2. ✅ シンガポールリージョンにデプロイ
3. ✅ バックアップしたデータベースをシンガポールリージョンにアップロード
4. ✅ アプリを再起動

### 所要時間

約5-10分

---

## 2. 東京リージョンへの復帰（シンガポール → 東京）

### 事前確認（推奨）

東京リージョンに戻す前に、リソース状況を確認できます：

```bash
cd backend
./scripts/check-region-resources.sh nrt
```

このスクリプトは以下の情報を表示します：
- リージョンのリソース状況（CAPACITY）
- デプロイの試行可能性

**結果の見方**:
- ✅ **CAPACITY > 0**: リソースが利用可能。デプロイを試行できます
- ❌ **CAPACITY < 0**: リソース不足。デプロイが失敗する可能性が高い

### 自動スクリプト

リソースが利用可能なことを確認したら、復帰スクリプトを実行：

```bash
cd backend
./scripts/switch-back-to-primary-region.sh
```

### 処理内容

1. ✅ シンガポールリージョンから最新のデータベースをバックアップ
2. ✅ 東京リージョンにデプロイ
3. ✅ バックアップしたデータベースを東京リージョンにアップロード
4. ✅ アプリを再起動

### 所要時間

約5-10分（リソースが利用可能な場合）

### 注意事項

- **リソース不足が解消されていない場合**: デプロイが失敗する可能性があります
- **その場合**: シンガポールリージョンで運用を継続してください

---

## 3. データの整合性

### ✅ データは保持されます

- 切り替え前のリージョンのデータは失われません（ボリュームに保存されているため）
- 切り替え先のリージョンに最新のデータがコピーされます

### ⚠️ 同時書き込みの問題

- **推奨**: 通常は1つのリージョンで運用
- **理由**: 両方のリージョンで同時に書き込みを行うと、データの不整合が発生する可能性があります

### データの流れ

```
東京リージョン（nrt）                   シンガポールリージョン（sin）
┌─────────────────────┐                ┌─────────────────────┐
│ ボリューム: data    │                │ ボリューム: data_backup │
│ app.db (既存データ) │  ──[コピー]──> │ app.db (コピー後)    │
└─────────────────────┘                └─────────────────────┘
         ↑                                        ↓
         └──────────[復帰時にコピー]──────────────┘
```

---

## 4. トラブルシューティング

### デプロイが失敗する

#### 東京リージョンでリソース不足

```bash
# リソース状況を確認
fly platform regions | grep nrt

# シンガポールリージョンで運用を継続
fly status --region sin
```

#### シンガポールリージョンでエラー

```bash
# ログを確認
fly logs --region sin

# アプリの状態を確認
fly status --region sin
```

### データベースのアップロードが失敗する

```bash
# アプリを停止してから再試行
fly scale count 0 --region [nrt|sin] --yes
sleep 5

# データベースをアップロード
flyctl sftp shell --app live-schedule-api --region [nrt|sin] <<EOF
put data/backups/app.db.backup.[TIMESTAMP] /app/data/app.db
EOF

# アプリを再起動
fly scale count 1 --region [nrt|sin] --yes
```

### ボリュームが見つからない

```bash
# ボリューム一覧を確認
fly volumes list

# 必要に応じてボリュームを作成
fly volumes create data_backup --region sin --size 1
```

---

## 5. 運用フロー

### 通常運用

```
東京リージョン（nrt）で運用
    ↓
リソース不足が発生
    ↓
シンガポールリージョン（sin）に避難
    ↓
東京リージョンが復旧
    ↓
東京リージョン（nrt）に復帰
```

### 定期バックアップ

```bash
# 週1回: データベースのバックアップを実行
./scripts/backup-db.sh
```

---

## 6. コスト管理

### 無料プランの制限

- **メモリ**: 256MBのVMを最大3台まで
- **ストレージ**: 30日間停止しているマシンのディスクスペースに課金が発生

### コスト削減のヒント

1. **不要なマシンを停止**: シンガポールリージョンに避難したら、東京リージョンのマシンを停止
2. **復帰後はバックアップリージョンを停止**: 東京リージョンに復帰したら、シンガポールリージョンのマシンを停止

```bash
# マシンを停止（ボリュームは残る）
fly scale count 0 --region [nrt|sin] --yes
```

---

## まとめ

### ✅ 可能な操作

- シンガポールリージョンへの避難
- 東京リージョンへの復帰
- データベースの同期
- リージョン間のデータコピー

### ⚠️ 注意事項

- リージョン間でデータベースを手動で同期する必要があります
- 同時に両方のリージョンで書き込みを行うと、データの不整合が発生する可能性があります
- 通常は1つのリージョンで運用し、緊急時のみバックアップリージョンに切り替える

### 📝 スクリプト一覧

- `switch-to-backup-region.sh`: シンガポールリージョンへの避難
- `switch-back-to-primary-region.sh`: 東京リージョンへの復帰
- `backup-db.sh`: データベースの定期バックアップ

