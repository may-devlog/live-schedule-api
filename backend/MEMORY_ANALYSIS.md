# メモリ使用量分析

## アプリケーションの特性

### 1. Rust/Axumアプリケーション
- **メモリ効率**: 非常に高い（ガベージコレクションなし、ゼロコスト抽象化）
- **典型的なメモリ使用量**: 10-50MB（基本メモリ）
- **バイナリサイズ**: 約10-20MB（リリースビルド）

### 2. SQLiteデータベース
- **メモリ使用**: ディスクベース（メモリ内に全データを保持しない）
- **キャッシュ**: デフォルトで2MB程度
- **同時接続**: コネクションプールで制御（通常5-10接続）

### 3. 依存関係
- `axum`: 軽量なWebフレームワーク
- `tokio`: 非同期ランタイム（メモリ効率が良い）
- `sqlx`: SQLiteドライバー（軽量）
- `serde`: シリアライゼーション（必要時のみメモリ使用）

## 256MBでの動作見積もり

### 基本メモリ使用量
```
Rustバイナリ:          ~20MB
Axum/Tokioランタイム:  ~30MB
SQLiteライブラリ:      ~5MB
システムリソース:      ~20MB
─────────────────────────────
合計（基本）:          ~75MB
```

### 動作時のメモリ使用量
```
基本メモリ:            ~75MB
リクエスト処理:        ~10-30MB（同時リクエスト数による）
SQLiteキャッシュ:      ~2-10MB（データベースサイズによる）
一時的なデータ:        ~10-20MB（JSON処理など）
─────────────────────────────
合計（動作時）:        ~100-135MB
```

### 余裕
```
256MB - 135MB = 121MB（約47%の余裕）
```

## 256MBで問題ない理由

### ✅ 十分な理由
1. **Rustのメモリ効率**: ガベージコレクションがないため、メモリ使用量が予測可能
2. **SQLiteの軽量性**: ディスクベースで、メモリ内に全データを保持しない
3. **小規模なAPI**: 同時接続数が少ない想定
4. **シンプルな処理**: 複雑な計算や大量データ処理がない

### ⚠️ 注意が必要な場合
1. **データベースサイズ**: 100MB以上の場合、SQLiteキャッシュが増加
2. **同時接続数**: 50接続以上の場合、メモリ使用量が増加
3. **大量のJSON処理**: 大きなリクエスト/レスポンスを処理する場合

## 推奨事項

### 現在の設定（256MB）で問題ない
- ✅ 小規模なAPIサーバー
- ✅ データベースサイズが100MB未満
- ✅ 同時接続数が50未満
- ✅ シンプルなCRUD操作

### 監視すべき指標
1. **メモリ使用率**: 80%を超える場合は注意
2. **レスポンスタイム**: メモリ不足の場合は遅延が発生
3. **エラーログ**: OOM（Out of Memory）エラーがないか

### メモリ使用量の確認方法

```bash
# Fly.ioダッシュボードで確認
# https://fly.io/apps/live-schedule-api/metrics

# または、SSH経由で確認（アプリが起動している場合）
fly ssh console --app live-schedule-api -C "cat /sys/fs/cgroup/memory/memory.usage_in_bytes"
```

## 結論

**256MBで問題ありません。**

理由：
1. Rust/Axumアプリケーションはメモリ効率が非常に高い
2. SQLiteはディスクベースで、メモリ使用量が少ない
3. 現在のアプリケーション規模では、100-135MB程度の使用量が見込まれる
4. 121MB（約47%）の余裕がある

ただし、以下の場合は512MBへの増強を検討してください：
- データベースサイズが200MB以上
- 同時接続数が100以上
- メモリ使用率が80%を超えることが頻繁にある






