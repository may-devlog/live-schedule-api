# 完全デプロイガイド: Cloudflare Pages + Fly.io

このガイドでは、localhostで動作しているアプリを、Cloudflare Pages（フロントエンド）とFly.io（バックエンド）でWeb上に公開する手順を説明します。

## 📋 全体の流れ

1. **Fly.ioでバックエンドAPIをデプロイ**
2. **Cloudflare Pagesでフロントエンドをデプロイ**
3. **環境変数を設定して接続**
4. **動作確認**

---

## パート1: Fly.ioでバックエンドAPIをデプロイ

### ステップ1: Fly.ioアカウントの作成

1. https://fly.io にアクセス
2. 「Sign Up」をクリック
3. GitHubアカウントでサインアップ（推奨）
4. 無料プランで開始

### ステップ2: Fly.io CLIのインストール

ターミナルで以下を実行：

```bash
curl -L https://fly.io/install.sh | sh
```

インストール後、パスを通す：

```bash
# ~/.zshrcに追加（zshを使用している場合）
echo 'export FLYCTL_INSTALL="/Users/$(whoami)/.fly"' >> ~/.zshrc
echo 'export PATH="$FLYCTL_INSTALL/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc

# インストール確認
flyctl version
```

### ステップ3: Fly.ioにログイン

```bash
flyctl auth login
```

ブラウザが開くので、Fly.ioアカウントでログインしてください。

### ステップ4: アプリの初期化

```bash
cd backend
flyctl launch
```

以下の質問に答えます：

- **App name**: `live-schedule-api`（または任意の名前、後で変更可能）
- **Region**: `nrt`（東京）を選択
- **Postgres**: `No`（SQLiteを使用するため）
- **Redis**: `No`

既に`fly.toml`がある場合は、そのまま使用されます。

### ステップ5: 永続ストレージの作成（データベース用）

SQLiteのデータベースファイルを保存するために、永続ボリュームを作成：

```bash
flyctl volumes create data --region nrt --size 1
```

### ステップ6: 環境変数の設定

```bash
# JWT秘密鍵を生成
openssl rand -hex 32
```

生成された文字列をコピーして、以下を実行：

```bash
# 環境変数を設定（生成したJWT_SECRETを設定）
flyctl secrets set JWT_SECRET=ここに生成したランダムな文字列を貼り付け
flyctl secrets set DATABASE_URL=sqlite:///app/data/app.db
```

**注意**: `BASE_URL`と`ALLOWED_ORIGIN`は、後でCloudflare PagesのURLに設定します。

### ステップ7: デプロイ

```bash
flyctl deploy
```

初回デプロイには5-10分かかります。ビルドログが表示されます。

### ステップ8: アプリのURLを確認

```bash
flyctl status
```

以下のようなURLが表示されます：
- `https://live-schedule-api.fly.dev`

このURLをメモしておいてください。

### ステップ9: 動作確認

```bash
# ヘルスチェック
curl https://live-schedule-api.fly.dev/health
```

`{"status":"ok"}`が返ってくれば成功です。

---

## パート2: Cloudflare Pagesでフロントエンドをデプロイ

### ステップ1: Cloudflareアカウントの作成

1. https://pages.cloudflare.com にアクセス
2. 「Sign up」をクリック
3. メールアドレスまたはGitHubアカウントで登録
4. 無料プランで開始

### ステップ2: 環境変数ファイルの作成

```bash
cd frontend

# .env.productionを作成（Fly.ioのAPI URLを設定）
echo "EXPO_PUBLIC_API_BASE=https://live-schedule-api.fly.dev" > .env.production
```

**重要**: `https://live-schedule-api.fly.dev`は、実際のFly.ioのURLに置き換えてください。

### ステップ3: Gitリポジトリの準備

#### GitHubリポジトリを作成（まだの場合）

1. GitHubにログイン
2. 右上の「+」→「New repository」をクリック
3. リポジトリ名: `live-schedule-api`（任意）
4. 「Create repository」をクリック

#### コードをプッシュ

```bash
cd /Users/mei/workspace/live-schedule-api

# Gitリポジトリを初期化（まだの場合）
git init

# リモートリポジトリを追加（your-usernameを実際のGitHubユーザー名に置き換え）
git remote add origin https://github.com/your-username/live-schedule-api.git

# コミット
git add .
git commit -m "Initial commit for deployment"

# プッシュ
git push -u origin master
```

### ステップ4: Cloudflare Pagesでプロジェクトを作成

1. Cloudflareダッシュボードにログイン
2. 左メニューから「Workers & Pages」を選択
3. 「Pages」タブをクリック
4. 「Create a project」をクリック
5. 「Connect to Git」を選択
6. GitHubアカウントを連携（初回のみ、認証を許可）
7. リポジトリ `live-schedule-api` を選択
8. 「Begin setup」をクリック

### ステップ5: ビルド設定

以下の設定を入力：

- **Project name**: `live-schedule`（任意）
- **Production branch**: `master`（または`main`）
- **Framework preset**: `None`を選択
- **Build command**: 
  ```
  cd frontend && npm install && npm run build
  ```
- **Build output directory**: 
  ```
  frontend/web-build
  ```

### ステップ6: 環境変数の設定

1. 「Environment variables」セクションを開く
2. 「Add variable」をクリック
3. 以下を追加：
   - **Variable name**: `EXPO_PUBLIC_API_BASE`
   - **Value**: `https://live-schedule-api.fly.dev`（Fly.ioのURL）
4. 「Save and Deploy」をクリック

### ステップ7: デプロイの完了を待つ

ビルドとデプロイが自動的に開始されます。完了まで5-10分かかります。

### ステップ8: デプロイURLを確認

デプロイ完了後、以下のようなURLが発行されます：
- `https://live-schedule-xxxxx.pages.dev`

このURLをメモしておいてください。

---

## パート3: 環境変数の最終設定

### Fly.ioの環境変数を更新

Cloudflare PagesのURLが確定したら、Fly.ioの環境変数を更新：

```bash
cd backend

# BASE_URLとALLOWED_ORIGINを更新（Cloudflare PagesのURLに置き換え）
flyctl secrets set BASE_URL=https://live-schedule-xxxxx.pages.dev
flyctl secrets set ALLOWED_ORIGIN=https://live-schedule-xxxxx.pages.dev
```

### Fly.ioアプリを再起動

```bash
flyctl apps restart live-schedule-api
```

---

## パート4: 動作確認

### 1. フロントエンドの確認

ブラウザで以下にアクセス：
- `https://live-schedule-xxxxx.pages.dev`

### 2. API接続の確認

ブラウザの開発者ツール（F12）を開き、「Console」タブでエラーがないか確認。

### 3. ログイン機能のテスト

1. フロントエンドで新規登録を試す
2. ログインを試す
3. スケジュールの作成・表示を試す

---

## トラブルシューティング

### Fly.io関連

#### デプロイが失敗する

```bash
# ログを確認
flyctl logs

# ローカルでビルドをテスト
cd backend
docker build -t test-build .
```

#### データベースエラー

```bash
# ボリュームの確認
flyctl volumes list

# SSH接続して確認
flyctl ssh console
ls -la /app/data
```

### Cloudflare Pages関連

#### ビルドが失敗する

1. Cloudflare Pagesの「Deployments」タブでログを確認
2. ローカルでビルドをテスト：
   ```bash
   cd frontend
   npm install
   npm run build
   ```

#### 環境変数が反映されない

1. 環境変数を設定後、再デプロイが必要
2. 「Deployments」タブで「Retry deployment」をクリック

#### API接続エラー（CORSエラー）

1. Fly.ioの`ALLOWED_ORIGIN`が正しく設定されているか確認
2. ブラウザのコンソールでエラーメッセージを確認

---

## 次のステップ

### カスタムドメインの設定（オプション）

#### Cloudflare Pagesでカスタムドメイン

1. Cloudflare Pagesのプロジェクト設定を開く
2. 「Custom domains」タブをクリック
3. 「Set up a custom domain」をクリック
4. `schedule.null-relife.com`を入力
5. DNS設定の指示に従う

#### Fly.ioでカスタムドメイン

```bash
flyctl certs add api.null-relife.com
```

---

## まとめ

これで、localhostで動作していたアプリが、Web上で公開されました！

- **フロントエンド**: Cloudflare Pages（無料、高速CDN付き）
- **バックエンド**: Fly.io（無料枠あり、Rust対応）

両方とも無料プランで十分に動作します。問題があれば、ログを確認してトラブルシューティングしてください。


















